describe("PersistentStorage",function(){var b,a=window.localStorage;beforeEach(function(){b=new PersistentStorage("ns");spyOn(a,"getItem").andCallThrough();spyOn(a,"setItem").andCallThrough();spyOn(a,"removeItem").andCallThrough();spyOn(Date.prototype,"getTime").andReturn(0)});afterEach(function(){a.clear()});describe("#get",function(){it("should access localStorage with prefixed key",function(){b.get("key");expect(a.getItem).toHaveBeenCalledWith("__ns__key")});it("should return undefined when key does not exist",function(){expect(b.get("does not exist")).toEqual(undefined)});it("should return value as correct type",function(){b.set("string","i am a string");b.set("number",42);b.set("boolean",true);b.set("null",null);b.set("object",{obj:true});expect(b.get("string")).toEqual("i am a string");expect(b.get("number")).toEqual(42);expect(b.get("boolean")).toEqual(true);expect(b.get("null")).toBeNull();expect(b.get("object")).toEqual({obj:true})});it("should expire stale keys",function(){b.set("key","value",-1);expect(b.get("key")).toBeNull();expect(a.getItem("__ns__key__ttl")).toBeNull()})});describe("#set",function(){it("should access localStorage with prefixed key",function(){b.set("key","val");expect(a.setItem.mostRecentCall.args[0]).toEqual("__ns__key")});it("should JSON.stringify value before storing",function(){b.set("key","val");expect(a.setItem.mostRecentCall.args[1]).toEqual(JSON.stringify("val"))});it("should store ttl if provided",function(){var c=1;b.set("key","value",c);expect(a.setItem.argsForCall[0]).toEqual(["__ns__key__ttl__",c.toString()])})});describe("#remove",function(){it("should remove key from storage",function(){b.set("key","val");b.remove("key");expect(b.get("key")).toBeNull()})});describe("#clear",function(){it("should work with namespaces that contain regex characters",function(){b=new PersistentStorage("ns?()");b.set("key1","val1");b.set("key2","val2");b.clear();expect(b.get("key1")).toEqual(undefined);expect(b.get("key2")).toEqual(undefined)});it("should remove all keys that exist in namespace of engine",function(){b.set("key1","val1");b.set("key2","val2");b.set("key3","val3");b.set("key4","val4",0);b.clear();expect(b.get("key1")).toEqual(undefined);expect(b.get("key2")).toEqual(undefined);expect(b.get("key3")).toEqual(undefined);expect(b.get("key4")).toEqual(undefined)});it("should not affect keys with different namespace",function(){a.setItem("diff_namespace","val");b.clear();expect(a.getItem("diff_namespace")).toEqual("val")})});describe("#isExpired",function(){it("should be false for keys without ttl",function(){b.set("key","value");expect(b.isExpired("key")).toBe(false)});it("should be false for fresh keys",function(){b.set("key","value",1);expect(b.isExpired("key")).toBe(false)});it("should be true for stale keys",function(){b.set("key","value",-1);expect(b.isExpired("key")).toBe(true)})})});